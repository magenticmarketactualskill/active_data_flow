# frozen_string_literal: true
require 'active_data_flow'

# <%= class_name %>Flow demonstrates ActiveDataFlow functionality
#
# This DataFlow:
# - Reads from a source
# - Transforms data
# - Writes to a sink
class <%= class_name %>Flow

  def self.register
    @source = <%= render_template('source.rb') %>

    @sink = <%= render_template('sink.rb') %>
    
    @runtime = <%= render_template('runtime.rb') %>

    ActiveDataFlow::DataFlow.find_or_create(
      name: "<%= file_name %>_flow",
      source: source,
      sink: sink,
      runtime: runtime
    )
  end

  def run
    count = 0
    @source.each do |message|
      transformed = transform(message)
      @sink.write(transformed)
      count += 1
      break if count >= @source.batch_size
    end
  rescue StandardError => e
    Rails.logger.error("<%= class_name %>Flow error: #{e.message}")
    Rails.logger.error(e.backtrace.join("\n"))
    raise
  end

  private

  # Transforms data for processing
  def transform(data)
    # TODO: Implement your transformation logic here
    data
  end
end
